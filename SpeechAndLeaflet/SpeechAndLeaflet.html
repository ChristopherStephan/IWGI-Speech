<html>

<head>
    <meta charset="utf-8">
    <title>Speech Map</title>
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
    <!-- link rel="stylesheet" href=http://geo-arcgis.uni-muenster.de/iwgi/js/leaflet/leaflet/css" /> -->
    <!--Leaflet 0.7-->
    <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
    <link rel="stylesheet" href="http://geo-arcgis.uni-muenster.de/iwgi/js/Minimap/Control.MiniMap.css" />
    <link rel="stylesheet" href="http://geo-arcgis.uni-muenster.de/iwgi/js/geosearch/l.geosearch.css" />
    <link rel="stylesheet" href="http://geo-arcgis.uni-muenster.de/iwgi/js/zoomslider/L.Control.Zoomslider.css" />
    <link rel="stylesheet" href="http://geo-arcgis.uni-muenster.de/iwgi/js/Leaflet.Pancontrol/L.Control.Pan.css" />
    <link rel="stylesheet" href="http://geo-arcgis.uni-muenster.de/iwgi/js/Leaflet.Pancontrol/L.Control.Pan.ie.css" />
    <link rel="stylesheet" href="http://geo-arcgis.uni-muenster.de/iwgi/js/leaflet.locator/L.Control.Locate.css" />
    <link rel="stylesheet" href="http://geo-arcgis.uni-muenster.de/iwgi/js/leaflet.viewcenter/leaflet.viewcenter.css" />
    <link rel="stylesheet" href="http://geo-arcgis.uni-muenster.de/iwgi/js/Leaflet.loading/Control.Loading.css" />

    <style>
    body {
        margin: 0;
        padding: 0;
    }
    #map {
        position: absolute;
        top: 40;
        bottom: 0;
        width: 100%;
    }
    #map.leaflet-fullscreen {
        position: fixed;
        width: 100%;
        height: 100%;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        margin: 0;
        padding: 0;
        border: 0;
    }
    .leaflet-control-fullscreen {
        background-image: url(http://geo-arcgis.uni-muenster.de/iwgi/images/icon-fullscreen.png);
        left: 2px;
    }
    .leaflet-control-zoom {
        left: 2px;
    }
    .leaflet-control-zoom-in {
        visibility: hidden;
    }
    .leaflet-control-zoom-out {
        visibility: hidden;
    }
    .leaflet-control-zoom {
        height: 26px;
        width: 28px;
    }
    //uncomment this to hide the zoom in/out part of slider widget

    /*
	.leaflet-control-zoomslider-in {
		visibility: hidden;
	}
	
	.leaflet-control-zoomslider-out {
		visibility: hidden;
	}
	*/
    </style>

</head>

<body>
    <style>
    #start_button {
        position: absolute;
        top: 50px;
        right: 95px;
    }
    #LayerOnStreet {
        position: absolute;
        top: 100px;
        right: 95px;
    }
    #LayerOffStreet {
        position: absolute;
        top: 150px;
        right: 95px;
    }
    #LayerOnPopStructure {
        position: absolute;
        top: 200px;
        right: 95px;
    }
    #LayerOffPopStructure {
        position: absolute;
        top: 250px;
        right: 95px;
    }
    </style>

    <div id="transcript"></div>
    <div id="interim"></div>
    <div id="map"></div>

    <!--Startbutton for Speech-->
    <div id="text">
        <button id="start_button" onclick="startButton(event)">
            Click to start speaking with the map!
        </button>
    </div>

    <!--street Layer ON-->
    <div id="text">
        <button id="LayerOnStreet" onclick="streetArcGISServer.setMap(map);" class="btn success">
            Click to turn the Layer On
        </button>
    </div>

    <!--street Layer OFF-->
    <div id="text">
        <button id="LayeroffStreet" onclick="streetArcGISServer.setMap(null);" class="btn danger">
            Click to turn the Layer Off
        </button>
    </div>

    <!--popstructure Layer ON-->
    <div id="text">
        <button id="LayerOnPopStructure" onclick="popstructureArcGISServer.setMap(map);" class="btn success">
            Click to turn the Layer On
        </button>
    </div>

    <!--popstructure Layer OFF-->
    <div id="text">
        <button id="LayerOffPopStructure" onclick="popstructureArcGISServer.setMap(null);" class="btn danger">
            Click to turn the Layer Off
        </button>
    </div>


    <script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
    <!-- <script src="http://geo-arcgis.uni-muenster.de/iwgi/js/leaflet/leaflet.js" /> -->
    <!--Leaflet 0.7-->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.1/jquery.min.js"></script>
    <script src="http://geo-arcgis.uni-muenster.de/iwgi/js/lvector/lvector-custom.js"></script>
    <!--https://github.com/JasonSanford/leaflet-vector-layers -->
    <script src="http://geo-arcgis.uni-muenster.de/iwgi/js/Minimap/Control.MiniMap.js"></script>
    <!-- https://github.com/Norkart/Leaflet-MiniMap -->
    <script src="http://geo-arcgis.uni-muenster.de/iwgi/js/geosearch/l.control.geosearch.js"></script>
    <!-- https://github.com/smeijer/L.GeoSearch-->
    <script src="http://geo-arcgis.uni-muenster.de/iwgi/js/geosearch/l.geosearch.provider.google.js"></script>
    <!-- https://github.com/smeijer/L.GeoSearch-->
    <script src="http://geo-arcgis.uni-muenster.de/iwgi/js/leaflet.zoomfs/leaflet.zoomfs.js"></script>
    <!-- Fullscreen Button https://github.com/elidupuis/leaflet.zoomfs -->
    <script src="http://geo-arcgis.uni-muenster.de/iwgi/js/zoomslider/L.Control.Zoomslider.js"></script>
    <!-- http://kartena.github.io/Leaflet.zoomslider/ -->
    <script src="http://geo-arcgis.uni-muenster.de/iwgi/js/Leaflet.Pancontrol/L.Control.Pan.js"></script>
    <!-- http://kartena.github.io/Leaflet.Pancontrol/ -->
    <script src="http://geo-arcgis.uni-muenster.de/iwgi/js/leaflet.locator/L.Control.Locate.js"></script>
    <!-- https://github.com/domoritz/leaflet-locatecontrol -->
    <script src="http://geo-arcgis.uni-muenster.de/iwgi/js/leaflet.viewcenter/leaflet.viewcenter.js"></script>
    <!-- https://github.com/pwldp/leaflet.viewcenter -->
    <script src="http://geo-arcgis.uni-muenster.de/iwgi/js/Leaflet.loading/Control.Loading.js"></script>
    <!-- https://github.com/ebrelsford/Leaflet.loading -->




    <script>
    var centerPoint = new L.LatLng(51.95442, 7.62709); // initial view point
    var map = L.map('map', {
        center: [51.95442, 7.62709],
        zoom: 13,
        dragging: true,
        touchZoom: true,
        scrollWheelZoom: true,
        doubleClickZoom: true,
        boxZoom: true,
        tap: true,
        tapTolerance: 15,
        trackResize: true,
        worldCopyJump: false,
        closePopupOnClick: true,
        zoomsliderControl: true,
        loadingControl: true,
        zoomControl: false //disable the zoomControl to show only the zoom control, which handles the Fullscreen mode. Otherwise the map would have the ZoomIn and ZoomOut Control twice	
    });


    var locater = L.control.locate({
        position: 'topright', // set the location of the control
        drawCircle: true, // controls whether a circle is drawn that shows the uncertainty about the location
        follow: true, // follow the location if `watch` and `setView` are set to true in locateOptions
        stopFollowingOnDrag: false, // stop following when the map is dragged if `follow` is set to true
        circleStyle: {}, // change the style of the circle around the user's location
        markerStyle: {},
        followCircleStyle: {}, // set difference for the style of the circle around the user's location while following
        followMarkerStyle: {},
        circlePadding: [0, 0], // padding around accuracy circle, value is passed to setBounds
        metric: true, // use metric or imperial units
        watch: true,
        onLocationError: function (err) {
            alert(err.message)
        }, // define an error callback function
        onLocationOutsideMapBounds: function (context) { // called when outside map boundaries
            alert(context.options.strings.outsideMapBoundsMsg);
        },
        setView: true, // automatically sets the map view to the user's location
        strings: {
            title: "Show me where I am", // title of the locat control
            popup: "You are within {distance} {unit} from this point", // text to appear if user clicks on circle
            outsideMapBoundsMsg: "You seem located outside the boundaries of the map" // default message for onLocationOutsideMapBounds
        }
        //locateOptions: {}  // define location options e.g enableHighAccuracy: true
    }).addTo(map);


    // new search bar			
    new L.Control.GeoSearch({
        provider: new L.GeoSearch.Provider.Google()
    }).addTo(map);


    // init ViewCenter plugin
    var viewCenter = new L.Control.ViewCenter({
        position: 'topright'
    }).addTo(map);


	
    // create custom zoom control with fullscreen button
    var zoomFS = new L.Control.ZoomFS({
        position: 'topright'
    }).addTo(map);
    // you can bind to 2 events: enterFullscreen and exitFullscreen
    // note that these events are on the map object, not the zoomfs object...
    map.on('enterFullscreen', function () {
        if (window.console) window.console.log('enterFullscreen');
    });
    map.on('exitFullscreen', function () {
        if (window.console) window.console.log('exitFullscreen');
    });



    var osm = L.tileLayer('http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>'
    }).addTo(map);

    var minimal = L.tileLayer('http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/{styleId}/256/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade',
        styleId: 22677
    })


    //new vector layer
    var streetArcGISServer = new lvector.AGS({
        url: "http://giv-buerger1.uni-muenster.de/arcgis/rest/services/eGovernance/basic_muenster_map/MapServer/4",
        fields: "*",
        uniqueField: "OBJECTID",
        esriOptions: true,
        popupTemplate: '<div class="iw-content"><h3>{STRASSE}</h3>PLZ:{PLZ}<br>Length: {LENGTH}m</div>',
        singlePopup: true
    })


    //can be controlled by buttons
    var popstructureArcGISServer = new lvector.AGS({
        url: "http://giv-buerger1.uni-muenster.de/arcgis/rest/services/eGovernance/basic_muenster_map/MapServer/7",
        fields: "*",
        uniqueField: "NAME",
        esriOptions: true,
        popupTemplate: '<div class="iw-content"><h3>Population structure in {NAME}</h3>Area:{FLAECHE_QM}m²<br>Overal population structure: {GES_BEV}<br>0-17: {GES_0_17}<br>18-64: {GES_18_64}<br>65-x: {GES_65_} </div>',
        singlePopup: true
    })


    var baseLayers = {
        "Minimal": minimal,
        "OSM": osm
    };

    var operationalLayer = {
        "Streets": streetArcGISServer,
        "Population and PLZ": popstructureArcGISServer
    };


    //New minimap
    //Plugin magic goes here! Note that you cannot use the same layer object again, as that will confuse the two map controls
    var overviewMap = L.tileLayer('http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/997/256/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://cloudmade.com">CloudMade</a>'
    })
    var miniMap = new L.Control.MiniMap(overviewMap, {
        toggleDisplay: true,
        mapOptions: {
            panControl: false,
            zoomsliderControl: false,
            crs: L.CRS.Simple,
        }
    }).addTo(map);


    //Baselayer controll
    var layersControl = L.control.layers(baseLayers, operationalLayer, {
        collapsed: true
    }).addTo(map);


///////////////////////////////////////////////////////////////////////////////////////////////
//////////////////////////Speech///////////////////////////////////////////////////////////////
///////////////////////////////////////////////////////////////////////////////////////////////


    var recognition = new webkitSpeechRecognition();
    var final_transcript = '';
    var interim_transcript = '';
    var language = 'en-US'; // TODO: fetch language as option value from drop down box
    // en-GB

    recognition.continuous = true; // keep processing input until stopped
    recognition.interimResults = true; // show interim results
    recognition.lang = language; // specify the language

    recognition.onresult = function (event) {
        // Assemble the transcript from the array of results
        for (var i = event.resultIndex; i < event.results.length; ++i) {
            if (event.results[i].isFinal) {
                final_transcript = event.results[i][0].transcript;
            } else {
                interim_transcript = event.results[i][0].transcript;
            }
        }

        console.log("interim: " + interim_transcript);
        console.log("final: " + final_transcript);

        // update the web page
        if (final_transcript.length > 0) {
            $('#transcript').html(final_transcript);
        }

        if (interim_transcript.length > 0) {
            $('#interim').html(interim_transcript);
        }

        // handling commands

        if (final_transcript.indexOf("zoom in") >= 0) {
            map.zoomIn(1);
            console.log("Zoomed in");
            final_transcript = '';
        }

        if (final_transcript.indexOf("zoom out") >= 0) {
            map.zoomOut(1);
            console.log("Zoomed out");
            final_transcript = '';
        }

        if (final_transcript.indexOf("left") >= 0) {
            centerPoint.lng -= 0.08;
            map.panTo(centerPoint);
            console.log("Panned Left");
            final_transcript = '';
        }

        if (final_transcript.indexOf("right") >= 0) {
            centerPoint.lng += 0.08;
            map.panTo(centerPoint);
            console.log("Panned right");
            final_transcript = '';
        }

        if (final_transcript.indexOf("up") >= 0) {
            centerPoint.lat += 0.08;
            map.panTo(centerPoint);
            console.log("Panned up");
            final_transcript = '';
        }

        if (final_transcript.indexOf("down") >= 0) {
            centerPoint.lat -= 0.08;
            map.panTo(centerPoint);
            console.log("Panned down");
            final_transcript = '';
        }

        if (final_transcript.indexOf("adding Street Network") >= 0) {
            streetArcGISServer.setMap(map);
            console.log("adding Street Network");
            final_transcript = '';
        }

        if (final_transcript.indexOf("removing Street Network") >= 0) {
            streetArcGISServer.setMap(null);
            console.log("removing Street Network");
            final_transcript = '';
        }
    }



    function startButton(event) {
        final_transcript = '';
        recognition.start();
    }
    </script>
</body>

</html>